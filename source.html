<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Service providers</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="node_modules/reveal.js/css/reveal.css">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i" rel="stylesheet">
        <link rel="stylesheet" href="node_modules/reveal.js/css/theme/black.css">
        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="node_modules/reveal.js/lib/css/zenburn.css">
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-markdown>
                    <script type="text/template">
                        # Service providers

                        ## Writing reusable service providers
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        Things we'd discuss
                        --------------------

                        - Dependency injection
                        - Dependency injection container
                        - Difference from Service locator
                        - Service providers
                        - Silex 2.x and Pimple 3.x
                        - Reusing service providers
                        - PSR 11, ContainerInterface, PSR 11 meta
                        - Pimple interop

                        Note:

                        I'll start with a rather long intro where I'll go
                        through some basic principles and best practices.
                        What's a dependency and dependency injection?
                        Dependency injection container and how not to use it as a service locator.
                        When service providers help.
                        Examples of service providers with Silex 2.x and Pimple 3.x.
                        Reusing service providers between frameworks.
                        PSR11 and interoperability.
                    </script>
                </section>
                <section>
                    <section data-markdown data-transition="slide-in none-out">
                        <script type="text/template">
                            What's a dependency?
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function __construct()
                                {
                                    $this->brewery = new Brewery();
                                }

                                public function addAttendee(Attendee $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    $beer = new Beer('Bernard');
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>

                            Note:

                            We have a Meetup class with the ability to add attendees.
                            Whenever it adds a new attendee, the Meetup class needs to order more beer.
                            It creates a new Beer instance and uses the Brewery to order it.
                        </script>
                    </section>
                    <section data-markdown data-transition="none-in slide-out">
                        <script type="text/template">
                            What's a dependency?
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function __construct()
                                {
                                    <mark>$this->brewery = new Brewery();</mark>
                                }

                                public function addAttendee(Attendee $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    <mark>$beer = new Beer('Bernard');</mark>
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>

                            Note:

                            Beer and Brewery are dependencies of the Meetup class.
                            Actually a Meetup cannot possibly function without them.
                        </script>
                    </section>
                </section>
                <section>
                    <section data-markdown data-transition="slide-in none-out">
                        <script type="text/template">
                            Dependency injection
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function __construct(Brewery $brewery)
                                {
                                    <mark>$this->brewery = $brewery;</mark>
                                }

                                public function addAttendee(Attendee $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    $beer = new Beer('Bernard');
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>

                            Note:

                            Dependency injection is nothing more than a design pattern
                            which has a simple goal. Move dependency creation out of the class
                            and inject ready instances via the constructor or setters.

                            You can see we've injected the Brewery as a dependency.
                            It needs to be created prior to creating the Meetup instance.
                        </script>
                    </section>
                    <section data-markdown data-transition="none-in slide-out">
                        <script type="text/template">
                            Dependency injection
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function __construct(
                                    Brewery $brewery,
                                    BeerFactory $beerFactory
                                ) {
                                    $this->brewery = $brewery;
                                    <mark>$this->beerFactory = $beerFactory;</mark>
                                }

                                public function addAttendee(Attendee $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    <mark>$beer = $this->beerFactory->createBeer('Bernard');</mark>
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>

                            Note:

                            Here we've moved out the creation of new Beer instances
                            and instead have injected a BeerFactory which can create
                            new beers for us.

                            Some people think dependency injection is when the framework is
                            auto-magically injecting the required dependencies.

                            Some examples are AngularJS 1.x, Laravel service container, Silex actions.
                        </script>
                    </section>
                </section>
                <section>
                    <section data-markdown data-transition="slide-in none-out">
                        <script type="text/template">
                            Dependency inversion
                            --------------------

                            - "**D**" in **SOLID**
                            - Principle which inverts dependencies from top-down to bottom-up
                            - Allows flexibility, mobility and decoupling
                        </script>
                    </section>
                    <section data-markdown data-transition="none-in none-out">
                        <script type="text/template">
                            Dependency inversion
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function __construct(
                                    BreweryInterface $brewery,
                                    BeerFactoryInterface $beerFactory
                                ) {
                                    $this->brewery = $brewery;
                                    $this->beerFactory = $beerFactory;
                                }

                                public function addAttendee(AttendeeInterface $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    $beer = $this->beerFactory->createBeer('Bernard');
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>
                        </script>
                    </section>
                    <section data-markdown data-transition="none-in slide-out">
                        <script type="text/template">
                            Dependency inversion
                            --------------------

                            <pre><code data-trim data-noescape class="php">
                            class Meetup
                            {
                                public function addAttendee(AttendeeInterface $attendee)
                                {
                                    $this->attendees[] = $attendee;
                                    $preferredBeerType = null;

                                    if ($attendee implements BeerPreferenceInterface) {
                                        $preferredBeerType = $attendee->getPreferredBeerType();
                                    }

                                    $beer = $this->beerFactory->createBeer($preferredBeerType);
                                    $this->brewery->orderBeer($beer);
                                }
                            }
                            </code></pre>

                            Note:

                            We can go a step further and get the preferred beer type
                            of the attendee and we can do that by using interfaces.

                            The attendee interface here does not assume the beer preference capability
                            which achieves the Interface segregation principle.

                            The beer factory can create a default beer type if null is passed.
                        </script>
                    </section>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        Pushing Creation Upwards
                        ------------------------

                        - Meetup needs Brewery and BeerFactory instances
                        - MeetupManager will need to create them and create the Meetup.
                        - MeetupManager could have Brewery, BeerFactory and MeetupFactory injected.
                        - Controller will need to create them all to be able to inject them in MeetupManager.
                        - Bootstrap code will need to prepare everything and inject it into the Controller.

                        Note:

                        To implement dependency injection properly you will need to push
                        creation of dependencies up and up until you reach the top.

                        ---

                        Here's where dependency injection container comes into play.
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        Dependency injection container
                        ------------------------------

                        <pre><code data-trim data-noescape class="php">
                        $c = [];

                        $c['beer.default'] = 'Bernard';
                        $c['beer.factory'] = new BeerFactory($c['beer.default']);
                        $c['brewery'] = new Brewery();

                        $c['meetup.class'] = 'Meetup';
                        $c['meetup.factory'] = new MeetupFactory(
                            $c['meetup.class'],
                            $c['brewery'],
                            $c['beer.factory']
                        );
                        $c['meetup.manager'] = new MeetupManager($c['meetup.factory']);
                        </code></pre>

                        Note:

                        Here's a very simple version of a container.
                        It's just an array which holds configuration and instantiated services.
                        You can imagine this is just pseudo code for a more robust
                        dependency injection container with lazy instances allowing
                        to override configuration.
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        Service locator
                        ---------------

                        Dependency injection container could be used as a service&nbsp;locator.

                        <pre><code data-trim data-noescape class="php">
                        class MeetupController
                        {
                            public function actionShow($container)
                            {
                                $meetup = $container['meetup.factory']->createMeetup();
                            }
                        }
                        </code></pre>

                        Note:

                        The service locator pattern is about injecting the whole container
                        in the classes that would need services out of it.

                        In most cases this could be considered an anti-pattern
                        and you can probably see why.
                        - You hide the real dependencies of the class.
                        - It's harder to test.
                        - It couples the configuration of the container with the code in the services.
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ~~Service locator~~
                        -------------------

                        <pre><code data-trim data-noescape class="php">
                        class MeetupController
                        {
                            public function actionShow(MeetupManager $meetupManager)
                            {
                                $meetup = $meetupManager->getMeetupFactory()->createMeetup();
                            }
                        }
                        </code></pre>

                        <pre><code data-trim data-noescape class="php">
                        $controller = new MeetupController();
                        $controller->actionShow($c['meetup.manager']);
                        </code></pre>

                        Note:

                        When using the dependency injection container the services should not know about it.
                        They would continue to abide the dependency injection pattern.
                        The dependency injection container would be used from outside the services.
                        Of course some parts of a framework using a DIC could use it directly
                        to instantiate services and inject their dependencies.

                        The part of the system which would call the action would
                        probably know about the DIC, but the controller would not.
                        It would just expect things to be injected.
                    </script>
                </section>
            </div>
        </div>
        <script src="node_modules/reveal.js/lib/js/classList.js"></script>
        <script src="node_modules/reveal.js/lib/js/head.min.js"></script>
        <script src="node_modules/reveal.js/js/reveal.js"></script>
        <script src="node_modules/reveal.js/plugin/markdown/marked.js"></script>
        <script src="node_modules/reveal.js/plugin/markdown/markdown.js"></script>
        <script src="node_modules/reveal.js/plugin/notes/notes.js"></script>
        <script src="node_modules/reveal.js/plugin/highlight/highlight.js"></script>
        <script>
            hljs.initHighlightingOnLoad()
        </script>
        <script>
            var gaPropertyID = 'UA-9096220-8';
            // More info https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                history: true
            });
        </script>
        <script src="node_modules/reveal-ga/dist/reveal-ga.min.js"></script>
    </body>
</html>
